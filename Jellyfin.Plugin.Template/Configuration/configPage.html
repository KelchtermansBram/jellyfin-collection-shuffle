<!DOCTYPE html>
<html>
  <head>
    <title>Collection Shuffle Configuration</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .config-container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .config-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #0078d4;
      }
      .config-header h1 {
        color: #0078d4;
        margin: 0;
        font-size: 28px;
      }
      .config-header p {
        color: #666;
        margin: 10px 0 0 0;
        font-size: 16px;
      }
      .form-group {
        margin-bottom: 25px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #333;
        font-size: 16px;
      }
      .form-group input[type="checkbox"] {
        margin-right: 10px;
        transform: scale(1.2);
      }
      .form-group input[type="number"] {
        width: 100px;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      .form-group .description {
        color: #666;
        font-size: 14px;
        margin-top: 5px;
        font-style: italic;
      }
      .save-button {
        background-color: #0078d4;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 20px;
      }
      .save-button:hover {
        background-color: #106ebe;
      }
      .save-button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .status-message {
        margin-top: 20px;
        padding: 15px;
        border-radius: 4px;
        display: none;
      }
      .status-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .debug-info {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-top: 20px;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="config-container">
      <div class="config-header">
        <h1>Collection Shuffle Configuration</h1>
        <p>
          Configure how the plugin shuffles collections to randomize shows and
          episodes
        </p>
      </div>

      <form id="configForm">
        <div class="form-group">
          <label>
            <input type="checkbox" id="EnableCollectionShuffle" />
            Enable Collection Shuffle
          </label>
          <div class="description">
            Master toggle to enable or disable the collection shuffle
            functionality
          </div>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="PreventBackToBackShows" />
            Prevent Back-to-Back Shows
          </label>
          <div class="description">
            Prevent episodes from the same show from playing consecutively
          </div>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="ShuffleShowsFirst" />
            Shuffle Shows First
          </label>
          <div class="description">
            Randomize the order of different series before shuffling episodes
          </div>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="ShuffleEpisodesSecond" />
            Shuffle Episodes Second
          </label>
          <div class="description">
            Randomize the order of episodes within each individual series
          </div>
        </div>

        <div class="form-group">
          <label for="MaxConsecutiveShowsFromSameSeries"
            >Max Consecutive Shows from Same Series:</label
          >
          <input
            type="number"
            id="MaxConsecutiveShowsFromSameSeries"
            min="1"
            max="10"
          />
          <div class="description">
            Maximum number of consecutive episodes allowed from the same show
            (minimum: 1)
          </div>
        </div>

        <button type="submit" class="save-button" id="saveButton">
          Save Configuration
        </button>
      </form>

      <div id="statusMessage" class="status-message"></div>

      <div class="debug-info">
        <strong>Debug Information:</strong><br />
        Plugin ID: a1b2c3d4-e5f6-7890-abcd-ef1234567890<br />
        <span id="configStatus">Loading configuration...</span><br />
        <span id="apiStatus">Checking API availability...</span>
      </div>
    </div>

    <script>
      // Configuration page logic
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Collection Shuffle Configuration page loaded");
        updateDebugInfo("Page loaded successfully");

        // Check if Jellyfin API is available
        if (typeof ApiClient !== "undefined") {
          updateDebugInfo("Jellyfin API client available");
          loadConfiguration();
        } else if (typeof Dashboard !== "undefined") {
          updateDebugInfo("Jellyfin Dashboard available");
          loadConfigurationLegacy();
        } else {
          updateDebugInfo("ERROR: No Jellyfin API available");
          showStatus(
            "Jellyfin API not available. Please ensure you are running this in Jellyfin.",
            "error"
          );
        }

        document
          .getElementById("configForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            saveConfiguration();
          });
      });

      function updateDebugInfo(message) {
        const debugInfo = document.getElementById("configStatus");
        if (debugInfo) {
          debugInfo.textContent = message;
        }
        console.log("Debug:", message);
      }

      function loadConfiguration() {
        updateDebugInfo("Loading configuration via API client...");

        if (typeof ApiClient !== "undefined") {
          ApiClient.getPluginConfiguration(
            "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
          )
            .then(function (result) {
              updateDebugInfo("Configuration loaded successfully");
              if (result) {
                document.getElementById("EnableCollectionShuffle").checked =
                  result.EnableCollectionShuffle || false;
                document.getElementById("PreventBackToBackShows").checked =
                  result.PreventBackToBackShows || false;
                document.getElementById("ShuffleShowsFirst").checked =
                  result.ShuffleShowsFirst || false;
                document.getElementById("ShuffleEpisodesSecond").checked =
                  result.ShuffleEpisodesSecond || false;
                document.getElementById(
                  "MaxConsecutiveShowsFromSameSeries"
                ).value = result.MaxConsecutiveShowsFromSameSeries || 1;
              }
            })
            .catch(function (error) {
              updateDebugInfo("Error loading configuration: " + error.message);
              console.error("Error loading configuration:", error);
            });
        }
      }

      function loadConfigurationLegacy() {
        updateDebugInfo("Loading configuration via Dashboard...");

        if (typeof Dashboard !== "undefined") {
          Dashboard.getPluginConfiguration(
            "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
            function (result) {
              updateDebugInfo("Configuration loaded via Dashboard");
              if (result) {
                document.getElementById("EnableCollectionShuffle").checked =
                  result.EnableCollectionShuffle || false;
                document.getElementById("PreventBackToBackShows").checked =
                  result.PreventBackToBackShows || false;
                document.getElementById("ShuffleShowsFirst").checked =
                  result.ShuffleShowsFirst || false;
                document.getElementById("ShuffleEpisodesSecond").checked =
                  result.ShuffleEpisodesSecond || false;
                document.getElementById(
                  "MaxConsecutiveShowsFromSameSeries"
                ).value = result.MaxConsecutiveShowsFromSameSeries || 1;
              }
            }
          );
        }
      }

      function saveConfiguration() {
        const saveButton = document.getElementById("saveButton");
        const statusMessage = document.getElementById("statusMessage");

        saveButton.disabled = true;
        saveButton.textContent = "Saving...";

        const config = {
          EnableCollectionShuffle: document.getElementById(
            "EnableCollectionShuffle"
          ).checked,
          PreventBackToBackShows: document.getElementById(
            "PreventBackToBackShows"
          ).checked,
          ShuffleShowsFirst:
            document.getElementById("ShuffleShowsFirst").checked,
          ShuffleEpisodesSecond: document.getElementById(
            "ShuffleEpisodesSecond"
          ).checked,
          MaxConsecutiveShowsFromSameSeries:
            parseInt(
              document.getElementById("MaxConsecutiveShowsFromSameSeries").value
            ) || 1,
        };

        updateDebugInfo("Saving configuration: " + JSON.stringify(config));

        if (typeof ApiClient !== "undefined") {
          // Use modern API client
          ApiClient.updatePluginConfiguration(
            "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
            config
          )
            .then(function (result) {
              saveButton.disabled = false;
              saveButton.textContent = "Save Configuration";

              if (result) {
                updateDebugInfo(
                  "Configuration saved successfully via API client"
                );
                showStatus("Configuration saved successfully!", "success");
              } else {
                updateDebugInfo("Failed to save configuration via API client");
                showStatus(
                  "Failed to save configuration. Please try again.",
                  "error"
                );
              }
            })
            .catch(function (error) {
              saveButton.disabled = false;
              saveButton.textContent = "Save Configuration";
              updateDebugInfo("Error saving configuration: " + error.message);
              showStatus(
                "Error saving configuration: " + error.message,
                "error"
              );
            });
        } else if (typeof Dashboard !== "undefined") {
          // Use legacy Dashboard
          Dashboard.savePluginConfiguration(
            "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
            config,
            function (result) {
              saveButton.disabled = false;
              saveButton.textContent = "Save Configuration";

              if (result) {
                updateDebugInfo(
                  "Configuration saved successfully via Dashboard"
                );
                showStatus("Configuration saved successfully!", "success");
              } else {
                updateDebugInfo("Failed to save configuration via Dashboard");
                showStatus(
                  "Failed to save configuration. Please try again.",
                  "error"
                );
              }
            }
          );
        } else {
          saveButton.disabled = false;
          saveButton.textContent = "Save Configuration";
          updateDebugInfo("No API available for saving configuration");
          showStatus("No API available for saving configuration", "error");
        }
      }

      function showStatus(message, type) {
        const statusMessage = document.getElementById("statusMessage");
        statusMessage.textContent = message;
        statusMessage.className = `status-message status-${type}`;
        statusMessage.style.display = "block";

        setTimeout(function () {
          statusMessage.style.display = "none";
        }, 5000);
      }
    </script>
  </body>
</html>
